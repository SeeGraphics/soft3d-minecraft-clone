#include "text.h"
#include "render.h"
#include <stddef.h>

typedef struct {
  char c;
  u8 rows[7]; // 5-bit wide rows, top to bottom
} Glyph5x7;

static const Glyph5x7 FONT[] = {
    {'0', {0x0E, 0x11, 0x13, 0x15, 0x19, 0x11, 0x0E}},
    {'1', {0x04, 0x0C, 0x04, 0x04, 0x04, 0x04, 0x0E}},
    {'2', {0x0E, 0x11, 0x01, 0x02, 0x04, 0x08, 0x1F}},
    {'3', {0x0E, 0x11, 0x01, 0x06, 0x01, 0x11, 0x0E}},
    {'4', {0x02, 0x06, 0x0A, 0x12, 0x1F, 0x02, 0x02}},
    {'5', {0x1F, 0x10, 0x1E, 0x01, 0x01, 0x11, 0x0E}},
    {'6', {0x06, 0x08, 0x10, 0x1E, 0x11, 0x11, 0x0E}},
    {'7', {0x1F, 0x01, 0x02, 0x04, 0x08, 0x08, 0x08}},
    {'8', {0x0E, 0x11, 0x11, 0x0E, 0x11, 0x11, 0x0E}},
    {'9', {0x0E, 0x11, 0x11, 0x0F, 0x01, 0x02, 0x0C}},
    {'A', {0x0E, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11}},
    {'B', {0x1E, 0x11, 0x11, 0x1E, 0x11, 0x11, 0x1E}},
    {'C', {0x0E, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0E}},
    {'D', {0x1E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x1E}},
    {'E', {0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x1F}},
    {'F', {0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x10}},
    {'G', {0x0E, 0x11, 0x10, 0x17, 0x11, 0x11, 0x0F}},
    {'H', {0x11, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11}},
    {'I', {0x0E, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0E}},
    {'J', {0x1F, 0x01, 0x01, 0x01, 0x11, 0x11, 0x0E}},
    {'K', {0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11}},
    {'L', {0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1F}},
    {'M', {0x11, 0x1B, 0x15, 0x15, 0x11, 0x11, 0x11}},
    {'N', {0x11, 0x19, 0x15, 0x13, 0x11, 0x11, 0x11}},
    {'O', {0x0E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E}},
    {'P', {0x1E, 0x11, 0x11, 0x1E, 0x10, 0x10, 0x10}},
    {'Q', {0x0E, 0x11, 0x11, 0x11, 0x15, 0x12, 0x0D}},
    {'R', {0x1E, 0x11, 0x11, 0x1E, 0x14, 0x12, 0x11}},
    {'S', {0x0F, 0x10, 0x10, 0x0E, 0x01, 0x01, 0x1E}},
    {'T', {0x1F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04}},
    {'U', {0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E}},
    {'V', {0x11, 0x11, 0x11, 0x11, 0x11, 0x0A, 0x04}},
    {'W', {0x11, 0x11, 0x11, 0x15, 0x15, 0x1B, 0x11}},
    {'X', {0x11, 0x11, 0x0A, 0x04, 0x0A, 0x11, 0x11}},
    {'Y', {0x11, 0x11, 0x0A, 0x04, 0x04, 0x04, 0x04}},
    {'Z', {0x1F, 0x01, 0x02, 0x04, 0x08, 0x10, 0x1F}},
    {'a', {0x0E, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11}},
    {'b', {0x1E, 0x11, 0x11, 0x1E, 0x11, 0x11, 0x1E}},
    {'c', {0x0E, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0E}},
    {'d', {0x1E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x1E}},
    {'e', {0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x1F}},
    {'f', {0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x10}},
    {'g', {0x0E, 0x11, 0x10, 0x17, 0x11, 0x11, 0x0F}},
    {'h', {0x11, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11}},
    {'i', {0x0E, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0E}},
    {'j', {0x1F, 0x01, 0x01, 0x01, 0x11, 0x11, 0x0E}},
    {'k', {0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11}},
    {'l', {0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1F}},
    {'m', {0x11, 0x1B, 0x15, 0x15, 0x11, 0x11, 0x11}},
    {'n', {0x11, 0x19, 0x15, 0x13, 0x11, 0x11, 0x11}},
    {'o', {0x0E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E}},
    {'p', {0x1E, 0x11, 0x11, 0x1E, 0x10, 0x10, 0x10}},
    {'q', {0x0E, 0x11, 0x11, 0x11, 0x15, 0x12, 0x0D}},
    {'r', {0x1E, 0x11, 0x11, 0x1E, 0x14, 0x12, 0x11}},
    {'s', {0x0F, 0x10, 0x10, 0x0E, 0x01, 0x01, 0x1E}},
    {'t', {0x1F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04}},
    {'u', {0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E}},
    {'v', {0x11, 0x11, 0x11, 0x11, 0x11, 0x0A, 0x04}},
    {'w', {0x11, 0x11, 0x11, 0x15, 0x15, 0x1B, 0x11}},
    {'x', {0x11, 0x11, 0x0A, 0x04, 0x0A, 0x11, 0x11}},
    {'y', {0x11, 0x11, 0x0A, 0x04, 0x04, 0x04, 0x04}},
    {'z', {0x1F, 0x01, 0x02, 0x04, 0x08, 0x10, 0x1F}},
    {'(', {0x06, 0x08, 0x10, 0x10, 0x10, 0x08, 0x06}},
    {')', {0x0C, 0x02, 0x01, 0x01, 0x01, 0x02, 0x0C}},
    {':', {0x00, 0x04, 0x04, 0x00, 0x04, 0x04, 0x00}},
    {' ', {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},
};

static const Glyph5x7 *lookup_glyph(char c) {
  for (size_t i = 0; i < sizeof(FONT) / sizeof(FONT[0]); i++) {
    if (FONT[i].c == c) {
      return &FONT[i];
    }
  }
  return &FONT[sizeof(FONT) / sizeof(FONT[0]) - 1]; // space
}

void draw_char(u32 *buffer, int w, v2i pos, char c, u32 color) {
  const Glyph5x7 *g = lookup_glyph(c);
  for (int y = 0; y < 7; y++) {
    u8 row = g->rows[y];
    for (int x = 0; x < 5; x++) {
      if (row & (1 << (4 - x))) {
        set_pixel(buffer, w, (v2i){pos.x + x, pos.y + y}, color);
      }
    }
  }
}

void draw_text(u32 *buffer, int w, v2i pos, const char *text, u32 color) {
  int x = pos.x;
  for (const char *p = text; *p; ++p) {
    draw_char(buffer, w, (v2i){x, pos.y}, *p, color);
    x += 6; // 5px glyph + 1px space
  }
}
